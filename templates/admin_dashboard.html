{% extends "base.html" %}

{% block title %}Admin Dashboard{% endblock %}

{% block head %}
<style>
    /* Override navbar for admin */
    .navbar {
        background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%) !important;
    }

    .admin-page {
        padding: 40px 0;
        background: #1a202c;
        min-height: calc(100vh - 200px);
    }

    /* Admin Header */
    .admin-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 32px;
        flex-wrap: wrap;
        gap: 20px;
    }

    .admin-header h1 {
        color: white;
        font-size: 1.75rem;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .admin-badge {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        background: var(--color-secondary);
        color: white;
        border-radius: 50px;
        font-size: 0.85rem;
        font-weight: 600;
    }

    /* Stats Cards */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 32px;
    }

    .stat-card {
        background: #2d3748;
        border-radius: 16px;
        padding: 24px;
        color: white;
    }

    .stat-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
    }

    .stat-card-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
    }

    .stat-card-icon.users {
        background: rgba(59, 130, 246, 0.2);
    }

    .stat-card-icon.requests {
        background: rgba(16, 185, 129, 0.2);
    }

    .stat-card-icon.banned {
        background: rgba(239, 68, 68, 0.2);
    }

    .stat-card-icon.active {
        background: rgba(245, 158, 11, 0.2);
    }

    .stat-card-value {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 4px;
    }

    .stat-card-label {
        color: rgba(255, 255, 255, 0.7);
        font-size: 0.9rem;
    }

    .stat-card-change {
        font-size: 0.85rem;
        margin-top: 8px;
    }

    .stat-card-change.positive {
        color: #10b981;
    }

    .stat-card-change.negative {
        color: #ef4444;
    }

    /* Admin Grid */
    .admin-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 24px;
    }

    @media (max-width: 1100px) {
        .admin-grid {
            grid-template-columns: 1fr;
        }
    }

    /* Admin Sections */
    .admin-section {
        background: #2d3748;
        border-radius: 20px;
        overflow: hidden;
    }

    .admin-section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 24px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .admin-section-title {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 1.1rem;
        font-weight: 600;
        color: white;
    }

    .admin-section-body {
        padding: 24px;
    }

    /* User Table */
    .user-table {
        width: 100%;
        border-collapse: collapse;
    }

    .user-table th,
    .user-table td {
        padding: 16px;
        text-align: left;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        color: white;
    }

    .user-table th {
        font-size: 0.85rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: rgba(255, 255, 255, 0.6);
    }

    .user-table tbody tr {
        transition: background 0.2s ease;
    }

    .user-table tbody tr:hover {
        background: rgba(255, 255, 255, 0.05);
    }

    .user-row {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        font-weight: 600;
    }

    .user-avatar.senior {
        background: linear-gradient(135deg, #3b82f6, #60a5fa);
    }

    .user-avatar.youth {
        background: linear-gradient(135deg, #10b981, #34d399);
    }

    .user-info h4 {
        font-size: 0.95rem;
        margin-bottom: 2px;
    }

    .user-info p {
        font-size: 0.8rem;
        color: rgba(255, 255, 255, 0.5);
        margin: 0;
    }

    /* Status Badges */
    .status-badge {
        padding: 4px 12px;
        border-radius: 50px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .status-active {
        background: rgba(16, 185, 129, 0.2);
        color: #10b981;
    }

    .status-banned {
        background: rgba(239, 68, 68, 0.2);
        color: #ef4444;
    }

    .status-timeout {
        background: rgba(245, 158, 11, 0.2);
        color: #f59e0b;
    }

    /* Action Buttons */
    .action-btns {
        display: flex;
        gap: 8px;
    }

    .action-btn {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        transition: all 0.2s ease;
    }

    .action-btn.ban {
        background: rgba(239, 68, 68, 0.2);
        color: #ef4444;
    }

    .action-btn.ban:hover {
        background: #ef4444;
        color: white;
    }

    .action-btn.timeout {
        background: rgba(245, 158, 11, 0.2);
        color: #f59e0b;
    }

    .action-btn.timeout:hover {
        background: #f59e0b;
        color: white;
    }

    .action-btn.kick {
        background: rgba(139, 92, 246, 0.2);
        color: #8b5cf6;
    }

    .action-btn.kick:hover {
        background: #8b5cf6;
        color: white;
    }

    .action-btn.unban {
        background: rgba(16, 185, 129, 0.2);
        color: #10b981;
    }

    .action-btn.unban:hover {
        background: #10b981;
        color: white;
    }

    .action-btn.warn {
        background: rgba(59, 130, 246, 0.2);
        color: #3b82f6;
    }

    .action-btn.warn:hover {
        background: #3b82f6;
        color: white;
    }

    /* Search Bar */
    .search-bar {
        display: flex;
        gap: 12px;
        margin-bottom: 20px;
    }

    .search-input {
        flex: 1;
        padding: 12px 16px;
        background: rgba(255, 255, 255, 0.1);
        border: 2px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        color: white;
        font-size: 0.95rem;
    }

    .search-input::placeholder {
        color: rgba(255, 255, 255, 0.5);
    }

    .search-input:focus {
        outline: none;
        border-color: var(--color-primary);
    }

    /* Activity Log */
    .activity-log {
        max-height: 400px;
        overflow-y: auto;
    }

    .log-item {
        display: flex;
        gap: 12px;
        padding: 16px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .log-item:last-child {
        border-bottom: none;
    }

    .log-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
        flex-shrink: 0;
    }

    .log-icon.ban {
        background: rgba(239, 68, 68, 0.2);
    }

    .log-icon.timeout {
        background: rgba(245, 158, 11, 0.2);
    }

    .log-icon.kick {
        background: rgba(139, 92, 246, 0.2);
    }

    .log-icon.warn {
        background: rgba(59, 130, 246, 0.2);
    }

    .log-icon.unban {
        background: rgba(16, 185, 129, 0.2);
    }

    .log-content {
        flex: 1;
    }

    .log-content h4 {
        font-size: 0.9rem;
        color: white;
        margin-bottom: 4px;
    }

    .log-content p {
        font-size: 0.8rem;
        color: rgba(255, 255, 255, 0.5);
        margin: 0;
    }

    /* Modals */
    .admin-modal .modal-body {
        background: #2d3748;
        color: white;
    }

    .admin-modal .form-input,
    .admin-modal .form-select {
        background: rgba(255, 255, 255, 0.1);
        border-color: rgba(255, 255, 255, 0.2);
        color: white;
    }

    .admin-modal .form-label {
        color: rgba(255, 255, 255, 0.8);
    }

    /* Quick Stats */
    .quick-stat {
        display: flex;
        justify-content: space-between;
        padding: 12px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        color: white;
    }

    .quick-stat:last-child {
        border-bottom: none;
    }

    .quick-stat-label {
        color: rgba(255, 255, 255, 0.6);
    }

    .quick-stat-value {
        font-weight: 600;
    }

    /* Footer Override */
    .footer {
        background: #1a202c !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="admin-page">
    <div class="container">
        <!-- Admin Header -->
        <div class="admin-header animate-fade-in">
            <h1>üõ°Ô∏è Admin Dashboard</h1>
            <div style="display: flex; align-items: center; gap: 16px;">
                <span class="admin-badge">
                    <span>üë§</span>
                    <span>{{ admin.name }}</span>
                </span>
                <a href="{{ url_for('admin_logout') }}" class="btn btn-danger btn-sm">
                    Logout
                </a>
            </div>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid animate-fade-in-up">
            <div class="stat-card">
                <div class="stat-card-header">
                    <div>
                        <div class="stat-card-value">{{ stats.total_users }}</div>
                        <div class="stat-card-label">Total Users</div>
                    </div>
                    <div class="stat-card-icon users">üë•</div>
                </div>
                <div class="stat-card-change positive">‚Üë {{ stats.seniors }} seniors, {{ stats.youths }} youths</div>
            </div>

            <div class="stat-card">
                <div class="stat-card-header">
                    <div>
                        <div class="stat-card-value">{{ stats.active_users }}</div>
                        <div class="stat-card-label">Active Users</div>
                    </div>
                    <div class="stat-card-icon active">‚úÖ</div>
                </div>
                <div class="stat-card-change positive">Operating normally</div>
            </div>

            <div class="stat-card">
                <div class="stat-card-header">
                    <div>
                        <div class="stat-card-value">{{ stats.banned_users }}</div>
                        <div class="stat-card-label">Banned Users</div>
                    </div>
                    <div class="stat-card-icon banned">üö´</div>
                </div>
                <div class="stat-card-change">{{ stats.timeout_users }} in timeout</div>
            </div>

            <div class="stat-card">
                <div class="stat-card-header">
                    <div>
                        <div class="stat-card-value">{{ stats.total_requests }}</div>
                        <div class="stat-card-label">Total Requests</div>
                    </div>
                    <div class="stat-card-icon requests">üìã</div>
                </div>
                <div class="stat-card-change positive">{{ stats.open_requests }} open</div>
            </div>
        </div>

        <!-- Admin Grid -->
        <div class="admin-grid">
            <!-- User Management -->
            <div class="admin-section animate-fade-in-up stagger-1">
                <div class="admin-section-header">
                    <div class="admin-section-title">
                        <span>üë•</span>
                        <span>User Management</span>
                    </div>
                </div>
                <div class="admin-section-body">
                    <div class="search-bar">
                        <input type="text" class="search-input" placeholder="üîç Search users by name or email...">
                    </div>

                    <div style="overflow-x: auto;">
                        <table class="user-table">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Type</th>
                                    <th>Status</th>
                                    <th>Points</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user in users %}
                                <tr>
                                    <td>
                                        <div class="user-row">
                                            <div class="user-avatar {{ user.type }}">
                                                {{ user.name[0] }}
                                            </div>
                                            <div class="user-info">
                                                <h4>{{ user.name }}</h4>
                                                <p>{{ user.email }}</p>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span
                                            class="badge {% if user.type == 'senior' %}badge-info{% else %}badge-success{% endif %}">
                                            {{ user.type|capitalize }}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="status-badge status-{{ user.status }}">
                                            {{ user.status }}
                                        </span>
                                    </td>
                                    <td>
                                        <span style="color: #fbbf24; font-weight: 600;">
                                            ‚ú® {{ user.aura_points }}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="action-btns">
                                            {% if user.status == 'banned' %}
                                            <form action="{{ url_for('admin_unban_user', user_id=user.id) }}"
                                                method="POST" style="display: inline;">
                                                <button type="submit" class="action-btn unban" title="Unban User">
                                                    ‚úì
                                                </button>
                                            </form>
                                            {% else %}
                                            <button type="button" class="action-btn warn" title="Send Warning"
                                                onclick="warnUser({{ user.id }}, '{{ user.name }}')">
                                                ‚ö†Ô∏è
                                            </button>
                                            <button type="button" class="action-btn timeout" title="Timeout User"
                                                onclick="timeoutUser({{ user.id }}, '{{ user.name }}')">
                                                ‚è±Ô∏è
                                            </button>
                                            <button type="button" class="action-btn kick" title="Kick User"
                                                onclick="kickUser({{ user.id }}, '{{ user.name }}')">
                                                üë¢
                                            </button>
                                            <button type="button" class="action-btn ban" title="Ban User"
                                                onclick="banUser({{ user.id }}, '{{ user.name }}')">
                                                üö´
                                            </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div>
                <!-- Quick Stats -->
                <div class="admin-section animate-fade-in-up stagger-2" style="margin-bottom: 24px;">
                    <div class="admin-section-header">
                        <div class="admin-section-title">
                            <span>üìä</span>
                            <span>Platform Stats</span>
                        </div>
                    </div>
                    <div class="admin-section-body">
                        <div class="quick-stat">
                            <span class="quick-stat-label">Open Requests</span>
                            <span class="quick-stat-value">{{ stats.open_requests }}</span>
                        </div>
                        <div class="quick-stat">
                            <span class="quick-stat-label">Completed Requests</span>
                            <span class="quick-stat-value">{{ stats.completed_requests }}</span>
                        </div>
                        <div class="quick-stat">
                            <span class="quick-stat-label">Seniors</span>
                            <span class="quick-stat-value">{{ stats.seniors }}</span>
                        </div>
                        <div class="quick-stat">
                            <span class="quick-stat-label">Youths</span>
                            <span class="quick-stat-value">{{ stats.youths }}</span>
                        </div>
                    </div>
                </div>

                <!-- Activity Log -->
                <div class="admin-section animate-fade-in-up stagger-3">
                    <div class="admin-section-header">
                        <div class="admin-section-title">
                            <span>üìù</span>
                            <span>Admin Activity Log</span>
                        </div>
                    </div>
                    <div class="admin-section-body">
                        <div class="activity-log">
                            {% if logs %}
                            {% for log in logs %}
                            <div class="log-item">
                                <div class="log-icon {{ log.action }}">
                                    {% if log.action == 'ban' %}üö´
                                    {% elif log.action == 'timeout' %}‚è±Ô∏è
                                    {% elif log.action == 'kick' %}üë¢
                                    {% elif log.action == 'warn' %}‚ö†Ô∏è
                                    {% elif log.action == 'unban' %}‚úì
                                    {% else %}üìã{% endif %}
                                </div>
                                <div class="log-content">
                                    <h4>{{ log.action|capitalize }}: {{ log.target }}</h4>
                                    <p>{{ log.details }} ‚Ä¢ {{ log.timestamp[:16] }}</p>
                                </div>
                            </div>
                            {% endfor %}
                            {% else %}
                            <p style="color: rgba(255, 255, 255, 0.5); text-align: center; padding: 24px;">
                                No admin actions recorded yet
                            </p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Ban Modal -->
<div class="modal admin-modal" id="ban-modal">
    <div class="modal-header" style="background: #2d3748; border-color: rgba(255,255,255,0.1);">
        <h3 class="modal-title" style="color: white;">üö´ Ban User</h3>
        <button class="modal-close" onclick="CareSwap.Modal.close('ban-modal')" style="color: white;">√ó</button>
    </div>
    <form id="ban-form" method="POST">
        <div class="modal-body">
            <p style="margin-bottom: 16px;">Are you sure you want to ban <strong id="ban-user-name"></strong>?</p>
            <div class="form-group">
                <label class="form-label">Reason for Ban</label>
                <textarea name="reason" class="form-input form-textarea"
                    placeholder="Enter reason for banning this user..." required></textarea>
            </div>
        </div>
        <div class="modal-footer" style="background: #1a202c; border-color: rgba(255,255,255,0.1);">
            <button type="button" class="btn btn-ghost" onclick="CareSwap.Modal.close('ban-modal')"
                style="color: white;">Cancel</button>
            <button type="submit" class="btn btn-danger">Confirm Ban</button>
        </div>
    </form>
</div>

<!-- Timeout Modal -->
<div class="modal admin-modal" id="timeout-modal">
    <div class="modal-header" style="background: #2d3748; border-color: rgba(255,255,255,0.1);">
        <h3 class="modal-title" style="color: white;">‚è±Ô∏è Timeout User</h3>
        <button class="modal-close" onclick="CareSwap.Modal.close('timeout-modal')" style="color: white;">√ó</button>
    </div>
    <form id="timeout-form" method="POST">
        <div class="modal-body">
            <p style="margin-bottom: 16px;">Set a temporary timeout for <strong id="timeout-user-name"></strong></p>
            <div class="form-group">
                <label class="form-label">Duration (hours)</label>
                <select name="hours" class="form-input">
                    <option value="1">1 hour</option>
                    <option value="6">6 hours</option>
                    <option value="12">12 hours</option>
                    <option value="24" selected>24 hours</option>
                    <option value="48">48 hours</option>
                    <option value="72">72 hours (3 days)</option>
                    <option value="168">168 hours (1 week)</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Reason</label>
                <input type="text" name="reason" class="form-input" placeholder="Reason for timeout" required>
            </div>
        </div>
        <div class="modal-footer" style="background: #1a202c; border-color: rgba(255,255,255,0.1);">
            <button type="button" class="btn btn-ghost" onclick="CareSwap.Modal.close('timeout-modal')"
                style="color: white;">Cancel</button>
            <button type="submit" class="btn btn-accent">Apply Timeout</button>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
    function banUser(userId, userName) {
        document.getElementById('ban-user-name').textContent = userName;
        document.getElementById('ban-form').action = `/admin/user/${userId}/ban`;
        CareSwap.Modal.open('ban-modal');
    }

    function timeoutUser(userId, userName) {
        document.getElementById('timeout-user-name').textContent = userName;
        document.getElementById('timeout-form').action = `/admin/user/${userId}/timeout`;
        CareSwap.Modal.open('timeout-modal');
    }

    function kickUser(userId, userName) {
        if (confirm(`Are you sure you want to kick (force logout) ${userName}?`)) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/admin/user/${userId}/kick`;
            document.body.appendChild(form);
            form.submit();
        }
    }

    function warnUser(userId, userName) {
        const message = prompt(`Enter warning message for ${userName}:`);
        if (message) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/admin/user/${userId}/warn`;

            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'message';
            input.value = message;
            form.appendChild(input);

            document.body.appendChild(form);
            form.submit();
        }
    }

    // Search functionality
    document.querySelector('.search-input').addEventListener('input', function () {
        const query = this.value.toLowerCase();
        document.querySelectorAll('.user-table tbody tr').forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(query) ? '' : 'none';
        });
    });
</script>
{% endblock %}